# 오더 관리 기능 명세서

## 1. 개요
- **목적**: 세차 오더의 생명주기(발행~완료) 관리 및 모니터링
- **주요 기능**: 조회/필터링, 수기 발행, 상세/타임라인 확인, 상태 변경(완료/삭제)
- **독자 가이드**:
  - **운영부서**: [2. 운영 가이드](#2-운영-가이드-operations) 참고
  - **개발부서**: [3. 시스템 개발 명세](#3-시스템-개발-명세-development) 참고

---

## 2. 운영 가이드 (Operations)

### 2.1 화면 레이아웃 및 기능
```
┌────────────────────────────────────────────┐
│ [오더 발행] [목록 다운로드]                │ ← 액션 버튼
│ 검색/필터 영역 (칩으로 적용 조건 표시)     │
├────────────────────────────────────────────┤
│ 오더 목록 (Data Grid, 40건 단위)           │ ← 메인
│ - 행 클릭 → 우측 패널 오픈                 │
└────────────────────────────────────────────┘
```

#### A. 상단 액션 및 필터 영역
| 영역 | 기능 및 설명 |
| :--- | :--- |
| **액션 버튼** | **[오더 발행]**: 긴급/수기 오더 생성<br>**[목록 다운로드]**: 현재 조회된 목록을 Excel로 다운로드 |
| **검색** | 차량 번호(기본), 차량 ID, 오더 ID, 존 이름 기준 검색 |
| **필터** | **기간**: 발행일 기준 (기본: 최근 1개월)<br>**속성**: 지역, 오더 구분, 발행/세차 유형<br>**파트너**: 파트너사 명, 유형(현장/입고), 진행 상태<br>**취소 유형**: 진행 상태가 '취소'일 때만 표시 (변경취소, 미예약취소, 노쇼취소, 수행원취소, 우천취소) |
| **필터 동작** | 지역1 변경 시 지역2 자동 초기화 |
| **편의기능** | **칩(Chip)**: 적용된 필터 확인 및 개별 삭제 (X 클릭)<br>**초기화**: 모든 조건 리셋 + 기간을 최근 1개월로 복원 |

#### B. 오더 목록 (Data Grid)
- **구성**: 오더ID, 구분, 차량정보, 지역, 파트너 정보, 진행 상태(배지) 등 표시
- **기능**: 헤더 클릭 시 정렬, 행 클릭 시 상세 패널 오픈, 페이지네이션(40건)
- **상태 배지 색상**: 완료(초록) / 발행(주황) / 예약(주황) / 수행 중(파랑) / 취소(회색)

#### C. 오더 상세 패널 (Drawer)
목록 클릭 시 우측에서 열리며 3개의 탭으로 구성됩니다.

| 탭 명 | 주요 내용 및 기능 |
| :--- | :--- |
| **① 상세정보** | - **기본 정보**: 오더 ID, 차량 번호, 차종, 존, 지역, 발행/세차 유형, 파트너, 수행원, 진행 상태, 발행/수행 일시, 메모<br>- **탁송 정보** (입고 파트너 전용): 입고/출고 예약 ID 및 탁송 상태. 별도 카드로 표시.<br>- **금액 및 연계 정보**: 최종 청구 금액, 연계 오더 (입고 파트너 전용)<br>- **[수행 완료]**: 작업 및 점검 종료 처리<br>- **[오더 취소]**: 오더 취소 (사유 입력 필수, 취소 상태에서는 버튼 숨김) |
| **② 사진 및 점검** | - **진행 이력**: 상태 변경 타임라인<br>- **사진**: 세차 전/후 사진, 기타 사진<br>- **점검 리스트**: 유형별(A~D) 점검 결과 및 이상 항목 확인 |
| **③ 미션 및 분실물** | - **미션**: 연동된 미션 목록 및 상태<br>- **분실물**: 분실물 ID(클릭 시 새창), 접수일시, 분실물 구분, 처리상태, 상세 정보 |

---

### 2.2 업무 시나리오 및 규칙

#### 주요 시나리오
**1. 긴급 오더 발행**
- [오더 발행] 클릭 → 차량번호 입력 → 차량정보 자동조회 (차종, 존, 파트너 표시)
- 오더 구분 "긴급" 선택 → 발행유형/세차유형 선택 → [발행하기]
- 결과: 대기 미션 N건 자동 포함 알림

**2. 오더 완료 처리**
- 목록에서 행 클릭 → [② 사진 및 점검] 탭에서 세차 전/후 사진, 점검 리스트 확인
- [③ 미션 및 분실물] 탭에서 수행원이 처리한 미션 확인 (선택적 수행)
- [수행 완료] 버튼 클릭 → 오더 상태 "완료"로 변경

#### 예외 및 주의사항 (FAQ)
-   **차량 조회 실패**: 시스템 미등록 차량은 오더 발행 불가 (차량 등록 선행 필요).
-   **오더 취소**: 취소 시 상태가 '취소'로 변경되며, 반드시 사유를 입력해야 함 (감사 로그 기록).
-   **미션 연동**: 오더 발행 시 해당 차량에 할당된 '대기' 미션이 자동으로 포함되며, 수행원이 선택적으로 처리. 수행 완료한 미션만 '완료' 상태로 변경됨.

---

## 3. 시스템 개발 명세 (Development)

### 3.1 데이터 모델 (Data Structure)

#### 핵심 엔티티 정의
| 구분 | 필드 구성 | 비고 |
| :--- | :--- | :--- |
| **오더 기본** | **ID**, 구분(긴급/정규...), 발행유형, 세차유형, 점검유형(A/B/C/D), 상태, **취소유형**, **rootOrderId**, **rootCreatedAt** | 점검유형은 세차유형에 종속. 취소유형은 취소 상태에서만 유효. rootOrderId/rootCreatedAt은 오더 체인 추적용 |
| **차량 정보** | 차량 ID, 번호, 차종, 존(ID/이름), 지역(1/2) | 오더 발행 시 실시간 조회 |
| **파트너** | 파트너 명, 유형(현장/입고/핸들러), 수행원 | 유형 기본값: 현장 |
| **탁송 정보** | 입고 예약 ID, 입고 탁송 상태, 출고 예약 ID, 출고 탁송 상태 | 입고 파트너 전용. 오더 상세 화면에서 별도 카드로 표시. 출고 정보는 완료 상태에서만 표시되며, 그 외 상태에서는 '-' 표시. 탁송 상태: WAITING(매칭 전), ASSIGN(매칭 완료), RUN(운행 중), END(운행 종료), FORCE_END(강제 반납), CANCEL(예약 취소), ETC(알 수 없음) |
| **상세 데이터** | 메모, 사진(전/후/기타), 점검결과(JSON), 미션(Snapshot), 분실물 | 분실물: ID, 접수일시, 구분, 상태, 상세 정보 |

#### 취소 유형 정의
오더가 취소될 때 사유에 따라 아래 유형으로 분류됩니다.

| 취소 유형 | 설명 |
|:---|:---|
| **변경취소** | 고객 요청 또는 운영 사유로 오더 내용 변경 시 기존 오더 취소 후 재발행 |
| **미예약취소** | 발행 후 24시간 내 파트너 예약 미완료로 인한 자동 취소 |
| **노쇼취소** | 예약 시간에 차량 미도착 또는 수행 불가 상황 |
| **수행원취소** | 수행원 사유로 인한 오더 취소 |
| **우천취소** | 우천으로 인한 세차 불가 취소 |

#### 오더 체인 구조 (Order Chain)
오더는 취소 후 재발행될 수 있으며, 이를 추적하기 위한 필드가 있습니다.

| 필드 | 타입 | 설명 |
|:---|:---|:---|
| **rootOrderId** | String (nullable) | 최초 원본 오더 ID. null이면 본인이 최초 오더 |
| **rootCreatedAt** | String (Date) | 최초 원본 오더의 발행 시점. 리드 타임 계산 기준 |

**오더 체인 예시**
```
O-90000 (root, 최초 발행: 12/25)
    ↓ 변경취소
O-90001 (재발행: 12/28, rootOrderId: O-90000, rootCreatedAt: 12/25)
    ↓ 미예약취소
O-90002 (재발행: 12/30, rootOrderId: O-90000, rootCreatedAt: 12/25)
```

**리드 타임 계산**
- 리드 타임 = 현재 시점 - `rootCreatedAt`
- 재발행된 오더도 최초 발행 시점 기준으로 계산됨
- 리스크 오더의 리드 타임이 길수록 우선 처리 필요

#### 점검 유형 매핑 로직
세차 유형 선택 시 `점검 유형`은 아래 규칙에 따라 자동 결정됩니다.
-   **A 유형**: 입고 파트너 (특수, 협의) - 전체 점검 + 긴급조치/시트탈거 항목
-   **B 유형**: 입고 파트너 (내외부), 현장 파트너 (긴급) - 전체 점검 (긴급조치 제외)
-   **C 유형**: 현장 파트너 (내외부, 내부, 외부) - 전체 점검 (해당 영역 항목만)
-   **D 유형**: 라이트 세차 - 라이트 전용 항목

> **⚠️ 파트너 유형별 세차 유형 제약**
> | 파트너 유형 | 허용 세차 유형 | 비고 |
> |:---:|:---|:---|
> | **입고** | 내외부, 협의, 특수 | 내부/외부 단독 불가 |
> | **현장** | 내외부, 내부, 외부, 라이트 | - |
> | **핸들러** | 기계세차 | - |

---

### 3.2 비즈니스 로직 및 상태 관리

#### 1) 상태 전이 (State Machine)
**기본 흐름 (모든 파트너 유형 공통)**
-   `발행` → `예약` → `수행 중` → `완료`
-   모든 단계에서 `취소` 가능

**파트너 유형별 상세 정의**
-   **현장 파트너**: 기본 흐름 그대로 사용
-   **입고 파트너**:
    -   기본 흐름 사용
    -   오더 상세 화면에서 "탁송 정보" 카드가 별도로 표시됨 (배치 순서: 기본 정보 → 탁송 정보 → 금액 및 연계 정보)
    -   입고 탁송 정보(예약 ID, 상태)는 모든 오더 상태에서 표시
    -   출고 탁송 정보는 완료 상태에서만 표시, 그 외에는 '-' 표시
-   **핸들러 파트너**:
    -   용도: 현장 수행원이 조치 못하는 외부 오염(진흙, 염화칼슘, 눈자국) 발생 시 자동 기계세차 수행 요청
    -   오더 특성: 오더 구분=변경, 발행 유형=미션핸들, 세차 유형=기계세차, 파트너 명='핸들러' (고정)
    -   **상태별 진행 이력**:
        -   `발행`: 미션핸들 생성 시 (탁송 상태: WAITING 매칭 전)
        -   `예약`: 미션핸들 매칭 시 (탁송 상태: ASSIGN 매칭 완료)
        -   `수행 중`: 미션핸들 수행 시 (탁송 상태: RUN 운행 중)
        -   `완료`: 미션핸들 반납 시 (탁송 상태: END 운행 종료 또는 FORCE_END 강제 반납)
        -   `취소`: 미션핸들 취소 시 (탁송 상태: CANCEL 예약 취소)
    -   **UI 동작**:
        -   오더 상세 화면에서 "상세정보", "사진 및 점검" 탭 표시. "미션 및 분실물" 탭은 숨김
        -   파트너 명: '핸들러' (고정값)
        -   수행원 필드: '-' 표시 (핸들러 오더는 수행원 배정 없음)
        -   "미션핸들 예약 정보" 카드 표시 (미션핸들 예약 ID, 예약 상태)
        -   "금액 및 연계 정보" 카드 숨김 (청구 금액 없음)
    -   **사진 및 점검 탭 (핸들러 전용)**:
        -   진행 이력: 상태별 탁송 상태 연계 표시
        -   세차 전 사진: 1~5장, 핸들러 서비스 응답 이미지 (세차 부위 구분 없음)
        -   세차 후 사진: 7~10장, 핸들러 서비스 응답 이미지 (세차 부위 구분 없음)
        -   세차 후기: 1~100자, 핸들러 서비스 응답 텍스트

#### 2) 미션 연동 프로세스 (Transaction)
**발행 시**
- 차량의 `대기` 상태 미션 조회 → 오더에 스냅샷 저장 + 미션 테이블 `OrderID` 업데이트

**수행 시**
- 수행원이 오더 수행 중 연결된 미션을 선택적으로 처리
- 미션 수행 완료 처리 시 → 해당 미션 상태 `완료`로 변경
- *미션 수행은 선택 사항이며 강제되지 않음*

**취소 시**
- 오더 연결 해제 처리
- 미션 상태는 실제 수행 여부에 따라 유지: 수행 완료된 미션은 `완료` 상태 유지, 미수행 미션은 `대기` 복원
- *미션은 오더에 종속되나 상태 생애주기는 독립적으로 관리됨*

#### 3) 수기 발행 유효성 검증
-   **필수값**: 차량번호(DB존재 확인), 오더구분, 발행유형, 세차유형.
-   **차량 검증**: 입력된 번호로 조회 실패 시 발행 차단 및 경고 메시지.

---

### 3.3 필터 및 대시보드 연동

#### 필터 상태 변수
| 필터 | 상태 변수 | 타입 | 설명 |
|:---|:---|:---|:---|
| 검색어 | fQuery | string | 차량번호, 차량ID, 오더ID, 존 검색 |
| 기간 시작 | fPeriodStart | string | 발행일 기준 시작일 |
| 기간 종료 | fPeriodEnd | string | 발행일 기준 종료일 |
| 지역1 | fRegion1 | string | 시/도 |
| 지역2 | fRegion2 | string | 구/군 |
| 오더 구분 | fOrderGroup | string | 긴급, 정규, 변경, 수시 |
| 발행 유형 | fOrderType | string | 세차 발행 유형 |
| 세차 유형 | fWashType | string | 내외부, 특수, 협의 등 |
| 파트너 | fPartner | string | 파트너사 명 |
| 파트너 유형 | fPartnerType | string | 현장, 입고, 핸들러 |
| 진행 상태 | fStatus | string | 발행, 예약, 수행 중, 완료, 취소 |
| **취소 유형** | **fCancelType** | string | 변경취소, 미예약취소, 노쇼취소, 수행원취소, 우천취소 |

#### 취소 유형 필터 UI
- **표시 조건**: 진행 상태(fStatus)가 '취소'일 때만 취소 유형 드롭다운 표시
- **기본값**: 전체 (빈 문자열)
- **옵션**: 전체, 변경취소, 미예약취소, 노쇼취소, 수행원취소, 우천취소

```jsx
{/* 취소 유형 필터 - status가 '취소'일 때만 표시 */}
{fStatus === "취소" && (
  <Select value={fCancelType} onChange={e => setFCancelType(e.target.value)}>
    <option value="">취소 유형 전체</option>
    <option value="변경취소">변경취소</option>
    <option value="미예약취소">미예약취소</option>
    <option value="노쇼취소">노쇼취소</option>
    <option value="수행원취소">수행원취소</option>
    <option value="우천취소">우천취소</option>
  </Select>
)}
```

#### 대시보드 연동 (Quick Filter)
대시보드에서 오더 관리 페이지로 이동 시 `quickFilter` props를 통해 필터 값 전달

**quickFilter 구조**
```typescript
interface QuickFilter {
  status?: string;      // 진행 상태 필터
  orderType?: string;   // 발행 유형 필터
  cancelType?: string;  // 취소 유형 필터
  partner?: string;     // 파트너 필터
}
```

**대시보드 → 오더관리 매핑**
| 대시보드 클릭 요소 | status | orderType | cancelType |
|:---|:---|:---|:---|
| 전체 오더 | - | - | - |
| 발행 | 발행 | - | - |
| 예약 | 예약 | - | - |
| 수행 중 | 수행 중 | - | - |
| 취소 (전체) | 취소 | - | - |
| 변경취소 | 취소 | - | 변경취소 |
| 미예약취소 | 취소 | - | 미예약취소 |
| 노쇼취소 | 취소 | - | 노쇼취소 |
| 수행원취소 | 취소 | - | 수행원취소 |
| 우천취소 | 취소 | - | 우천취소 |
| 위생장애 | - | 위생장애 | - |
| ML긴급 | - | 고객 피드백(ML)_긴급 | - |
| 초장기미세차 | - | 초장기 미세차 | - |

**OrdersPage 초기화 로직**
```javascript
useEffect(() => {
  if (quickFilter) {
    if (quickFilter.status) setFStatus(quickFilter.status);
    if (quickFilter.orderType) setFOrderType(quickFilter.orderType);
    if (quickFilter.cancelType) setFCancelType(quickFilter.cancelType);
    if (quickFilter.partner) setFPartner(quickFilter.partner);
  }
}, [quickFilter]);
```

---

### 3.4 상세 기능 구현 명세

#### 점검 항목 및 결과 처리

**점검 항목 정의**

| 유형 | 항목 구성 |
| :--- | :--- |
| **공통 (A/B/C)** | 적산거리, 타이어트레드, 유리창, 배터리전압, 안전삼각대, 차량용 소화기, 워셔액통, 발판매트, 타이어파스/펑크, 시동불가, 본넷, 타이어마모 **(12개)** |
| **A 전용** | 긴급조치내용, 시트탈거, 부품교체금액, 방향제, 와이퍼, 시트/폴딩, 차량경고등(다중), 외관파손(다중) **(8개)** |
| **B 전용** | A와 유사하나 시트탈거/부품교체금액 제외 |
| **C 전용** | B와 유사하나 긴급조치내용 제외 |
| **D (라이트)** | 외관점검부위, 외관이상유형, 외관오염도, 타이어상태, 내부오염위치(다중), 배터리상태, 와이퍼워셔액, 후속조치 **(8개)** |

**데이터 구조**: `{ value: 값, status: "정상"|"이상", photo?: url[] }`

**표시 규칙**:
- 타이어 관련: 2x2 Grid (FL/FR/RL/RR)
- 이상 항목: 빨간색 '이상' 배지 + 증빙 사진 썸네일 노출
- 다중선택: 개별 배지로 나열

#### 사진 처리 (Display Logic)
-   **조건부 렌더링**: `D 유형(라이트)`일 경우 **'세차 전 사진' 섹션 미노출**
-   **UI**: 반응형 그리드(3~5열), 썸네일 클릭 시 모달 팝업

#### 오더 취소 및 완료
-   **취소**: [오더 취소] 버튼 → 사유 입력 팝업(필수) → 확정 시 오더 상태 "취소"로 변경 및 감사 로그 적재
-   **완료**: [수행 완료] 버튼 → 오더 상태 "완료" 처리 (미션은 수행원이 개별적으로 완료 처리한 것만 '완료' 상태 유지)

---

### 3.5 데이터 구조 예시

#### 오더 JSON 구조
```json
{
  "orderId": "O-90001",
  "washType": "특수",
  "orderGroup": "긴급",
  "orderType": "위생장애",
  "carId": "C-1001",
  "model": "GV70",
  "plate": "15라1184",
  "zone": "서초 1번존",
  "zoneId": "Z-1001",
  "region1": "서울",
  "region2": "서초",
  "partner": "C파트너",
  "partnerType": "입고",
  "status": "취소",
  "cancelType": "변경취소",
  "elapsedDays": 26,
  "worker": "신81",
  "comment": "고객 요청으로 세차 일정 변경",
  "createdAt": "2025-12-28",
  "completedAt": null,
  "rootOrderId": "O-80050",
  "rootCreatedAt": "2025-12-20",
  "inspectionType": "A",
  "preWashPhotos": [...],
  "postWashPhotos": [...],
  "inspectionResults": {...}
}
```

#### 필드 상세 설명
| 필드 | 타입 | 필수 | 설명 |
|:---|:---|:---|:---|
| orderId | String | Y | 오더 고유 ID |
| washType | String | Y | 세차 유형 (내외부, 특수, 협의, 라이트 등) |
| orderGroup | String | Y | 오더 구분 (긴급, 정규, 변경, 수시) |
| orderType | String | Y | 발행 유형 (위생장애, 수시세차, 반납 사진(ML) 등) |
| carId | String | Y | 차량 고유 ID |
| model | String | Y | 차종 |
| plate | String | Y | 차량 번호 |
| zone | String | Y | 존 이름 |
| zoneId | String | Y | 존 고유 ID |
| region1 | String | Y | 지역1 (시/도) |
| region2 | String | Y | 지역2 (구/군) |
| partner | String | Y | 파트너사 명 |
| partnerType | String | Y | 파트너 유형 (현장, 입고, 핸들러) |
| status | String | Y | 진행 상태 (발행, 예약, 수행 중, 완료, 취소) |
| **cancelType** | String | N | 취소 유형 (취소 상태에서만 유효) |
| elapsedDays | Number | N | 경과 일수 |
| worker | String | N | 수행원 ID |
| comment | String | N | 메모 |
| createdAt | String | Y | 오더 발행 일시 |
| completedAt | String | N | 수행 완료 일시 |
| **rootOrderId** | String | N | 최초 원본 오더 ID (null이면 본인이 root) |
| **rootCreatedAt** | String | Y | 최초 원본 오더 발행 시점 (리드 타임 기준) |
| inspectionType | String | Y | 점검 유형 (A, B, C, D) |
| preWashPhotos | Array | N | 세차 전 사진 목록 |
| postWashPhotos | Array | N | 세차 후 사진 목록 |
| inspectionResults | Object | N | 점검 결과 데이터 |