# 오더 관리 기능 명세서

## 1. 개요
- **목적**: 세차 오더의 생명주기(발행~완료) 관리 및 모니터링
- **주요 기능**: 조회/필터링, 수기 발행, 상세/타임라인 확인, 상태 변경(완료/삭제)
- **독자 가이드**:
  - **운영부서**: [2. 운영 가이드](#2-운영-가이드-operations) 참고
  - **개발부서**: [3. 시스템 개발 명세](#3-시스템-개발-명세-development) 참고

---

## 2. 운영 가이드 (Operations)

### 2.1 화면 레이아웃 및 기능
```
┌────────────────────────────────────────────┐
│ [오더 발행] [목록 다운로드]                │ ← 액션 버튼
│ 검색/필터 영역 (칩으로 적용 조건 표시)     │
├────────────────────────────────────────────┤
│ 오더 목록 (Data Grid, 40건 단위)           │ ← 메인
│ - 행 클릭 → 우측 패널 오픈                 │
└────────────────────────────────────────────┘
```

#### A. 상단 액션 및 필터 영역
| 영역 | 기능 및 설명 |
| :--- | :--- |
| **액션 버튼** | **[오더 발행]**: 긴급/수기 오더 생성<br>**[목록 다운로드]**: 현재 조회된 목록을 Excel로 다운로드 |
| **검색** | 차량 번호(기본), 차량 ID, 오더 ID, 존 이름 기준 검색 |
| **필터** | **기간**: 발행일 기준 (기본: 최근 1개월)<br>**속성**: 지역, 오더 구분, 발행/세차 유형<br>**파트너**: 파트너사 명, 유형(현장/입고), 진행 상태 |
| **필터 동작** | 지역1 변경 시 지역2 자동 초기화 |
| **편의기능** | **칩(Chip)**: 적용된 필터 확인 및 개별 삭제 (X 클릭)<br>**초기화**: 모든 조건 리셋 + 기간을 최근 1개월로 복원 |

#### B. 오더 목록 (Data Grid)
- **구성**: 오더ID, 구분, 차량정보, 지역, 파트너 정보, 진행 상태(배지) 등 표시
- **기능**: 헤더 클릭 시 정렬, 행 클릭 시 상세 패널 오픈, 페이지네이션(40건)
- **상태 배지 색상**: 완료(초록) / 발행(주황) / 예약(주황) / 수행 중(파랑) / 취소(회색)

#### C. 오더 상세 패널 (Drawer)
목록 클릭 시 우측에서 열리며 3개의 탭으로 구성됩니다.

| 탭 명 | 주요 내용 및 기능 |
| :--- | :--- |
| **① 상세정보** | - 기본 정보, 시간 정보, 금액<br>- **입고 파트너 전용**: 탁송 정보(입고/출고 예약 ID, 탁송 상태), 연계 오더<br>- **[수행 완료]**: 작업 및 점검 종료 처리<br>- **[오더 취소]**: 오더 취소 (사유 입력 필수) |
| **② 사진 및 점검** | - **진행 이력**: 상태 변경 타임라인<br>- **사진**: 세차 전/후 사진, 기타 사진<br>- **점검 리스트**: 유형별(A~D) 점검 결과 및 이상 항목 확인 |
| **③ 미션 및 분실물** | - **미션**: 연동된 미션 목록 및 상태<br>- **분실물**: 분실물 ID(클릭 시 새창), 접수일시, 분실물 구분, 처리상태, 상세 정보 |

---

### 2.2 업무 시나리오 및 규칙

#### 주요 시나리오
**1. 긴급 오더 발행**
- [오더 발행] 클릭 → 차량번호 입력 → 차량정보 자동조회 (차종, 존, 파트너 표시)
- 오더 구분 "긴급" 선택 → 발행유형/세차유형 선택 → [발행하기]
- 결과: 대기 미션 N건 자동 포함 알림

**2. 오더 완료 처리**
- 목록에서 행 클릭 → [② 사진 및 점검] 탭에서 세차 전/후 사진, 점검 리스트 확인
- [③ 미션 및 분실물] 탭에서 수행원이 처리한 미션 확인 (선택적 수행)
- [수행 완료] 버튼 클릭 → 오더 상태 "완료"로 변경

#### 예외 및 주의사항 (FAQ)
-   **차량 조회 실패**: 시스템 미등록 차량은 오더 발행 불가 (차량 등록 선행 필요).
-   **오더 취소**: 취소 시 상태가 '취소'로 변경되며, 반드시 사유를 입력해야 함 (감사 로그 기록).
-   **미션 연동**: 오더 발행 시 해당 차량에 할당된 '대기' 미션이 자동으로 포함되며, 수행원이 선택적으로 처리. 수행 완료한 미션만 '완료' 상태로 변경됨.

---

## 3. 시스템 개발 명세 (Development)

### 3.1 데이터 모델 (Data Structure)

#### 핵심 엔티티 정의
| 구분 | 필드 구성 | 비고 |
| :--- | :--- | :--- |
| **오더 기본** | **ID**, 구분(긴급/정규...), 발행유형, 세차유형, 점검유형(A/B/C/D), 상태 | 점검유형은 세차유형에 종속 |
| **차량 정보** | 차량 ID, 번호, 차종, 존(ID/이름), 지역(1/2) | 오더 발행 시 실시간 조회 |
| **파트너** | 파트너 명, 유형(현장/입고/핸들러), 수행원 | 유형 기본값: 현장 |
| **탁송 정보** | 입고 예약 ID, 입고 탁송 상태, 출고 예약 ID, 출고 탁송 상태 | 입고 파트너 전용. 상태: WAITING(매칭 전), ASSIGN(매칭 완료), RUN(운행 중), END(운행 종료), FORCE_END(강제 반납), CANCEL(예약 취소), ETC(알 수 없음) |
| **상세 데이터** | 메모, 사진(전/후/기타), 점검결과(JSON), 미션(Snapshot), 분실물 | 분실물: ID, 접수일시, 구분, 상태, 상세 정보 |

#### 점검 유형 매핑 로직
세차 유형 선택 시 `점검 유형`은 아래 규칙에 따라 자동 결정됩니다.
-   **A 유형 (내외부, 특수)**: 전체 점검 + 긴급조치/시트탈거 항목
-   **B 유형 (내부, 협의)**: 전체 점검 (긴급조치 제외)
-   **C 유형 (외부)**: 전체 점검 (내부 항목 제외)
-   **D 유형 (라이트)**: 라이트 전용 항목

---

### 3.2 비즈니스 로직 및 상태 관리

#### 1) 상태 전이 (State Machine)
**기본 흐름 (모든 파트너 유형 공통)**
-   `발행` → `예약` → `수행 중` → `완료`
-   모든 단계에서 `취소` 가능

**파트너 유형별 상세 정의**
-   **현장 파트너**: 기본 흐름 그대로 사용
-   **입고 파트너**: 기본 흐름 사용 + 오더 상세 화면에서 입고/출고 관련 탁송 상태 및 예약 ID 별도 표시
-   **핸들러 파트너**:
    -   `예약`: 핸들러가 미션 핸들을 잡은 시점
    -   `수행 중`: 핸들러가 작업을 시작한 시점
    -   `완료`: 핸들러가 차량을 반납한 시점

#### 2) 미션 연동 프로세스 (Transaction)
**발행 시**
- 차량의 `대기` 상태 미션 조회 → 오더에 스냅샷 저장 + 미션 테이블 `OrderID` 업데이트

**수행 시**
- 수행원이 오더 수행 중 연결된 미션을 선택적으로 처리
- 미션 수행 완료 처리 시 → 해당 미션 상태 `완료`로 변경
- *미션 수행은 선택 사항이며 강제되지 않음*

**취소 시**
- 오더 연결 해제 처리
- 미션 상태는 실제 수행 여부에 따라 유지: 수행 완료된 미션은 `완료` 상태 유지, 미수행 미션은 `대기` 복원
- *미션은 오더에 종속되나 상태 생애주기는 독립적으로 관리됨*

#### 3) 수기 발행 유효성 검증
-   **필수값**: 차량번호(DB존재 확인), 오더구분, 발행유형, 세차유형.
-   **차량 검증**: 입력된 번호로 조회 실패 시 발행 차단 및 경고 메시지.

---

### 3.3 상세 기능 구현 명세

#### 점검 항목 및 결과 처리

**점검 항목 정의**

| 유형 | 항목 구성 |
| :--- | :--- |
| **공통 (A/B/C)** | 적산거리, 타이어트레드, 유리창, 배터리전압, 안전삼각대, 차량용 소화기, 워셔액통, 발판매트, 타이어파스/펑크, 시동불가, 본넷, 타이어마모 **(12개)** |
| **A 전용** | 긴급조치내용, 시트탈거, 부품교체금액, 방향제, 와이퍼, 시트/폴딩, 차량경고등(다중), 외관파손(다중) **(8개)** |
| **B 전용** | A와 유사하나 시트탈거/부품교체금액 제외 |
| **C 전용** | B와 유사하나 긴급조치내용 제외 |
| **D (라이트)** | 외관점검부위, 외관이상유형, 외관오염도, 타이어상태, 내부오염위치(다중), 배터리상태, 와이퍼워셔액, 후속조치 **(8개)** |

**데이터 구조**: `{ value: 값, status: "정상"|"이상", photo?: url[] }`

**표시 규칙**:
- 타이어 관련: 2x2 Grid (FL/FR/RL/RR)
- 이상 항목: 빨간색 '이상' 배지 + 증빙 사진 썸네일 노출
- 다중선택: 개별 배지로 나열

#### 사진 처리 (Display Logic)
-   **조건부 렌더링**: `D 유형(라이트)`일 경우 **'세차 전 사진' 섹션 미노출**
-   **UI**: 반응형 그리드(3~5열), 썸네일 클릭 시 모달 팝업

#### 오더 취소 및 완료
-   **취소**: [오더 취소] 버튼 → 사유 입력 팝업(필수) → 확정 시 오더 상태 "취소"로 변경 및 감사 로그 적재
-   **완료**: [수행 완료] 버튼 → 오더 상태 "완료" 처리 (미션은 수행원이 개별적으로 완료 처리한 것만 '완료' 상태 유지)

---

### 3.4 프로토타입에서 구현된 기능
- ✅ 검색 및 필터 (전체 조건)
- ✅ 오더 목록 표시 및 페이지네이션
- ✅ 정렬 기능
- ✅ 오더 수동 발행 (차량 조회, 미션 자동 연동)
- ✅ 오더 상세 (3개 탭 구조)
- ✅ 점검 유형별 점검 항목 표시
- ✅ 세차 전/후 사진 그리드
- ✅ 진행 이력 타임라인
- ✅ 오더 완료 처리
- ✅ 오더 삭제 (사유 입력)