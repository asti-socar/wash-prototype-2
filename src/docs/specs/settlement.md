# 합의 요청 관리 기능 명세서

## 1. 개요
- **화면명**: 합의 요청 관리
- **목적**: 세차 수행 중 발견된 특이사항(오염 심각, 추가 과업 등)으로 인해 파트너사가 추가 비용을 요청할 경우, 이를 검토하고 합의(승인/반려/네고)하는 프로세스를 관리합니다.
- **주요 기능**: 요청 목록 조회, 사유 및 현장 사진 확인, 청구 금액 조정, 승인 및 반려 처리.

## 2. 화면 구성 및 기능

### 2.1 합의 요청 목록 (List)
파트너사로부터 접수된 합의 요청 건들을 테이블 형태로 조회합니다.

- **페이지네이션**: 페이지당 **40건** 기준.
- **기본 정렬**: 오더 ID **내림차순** (최신 오더 우선 표시)
- **정렬**: 헤더 클릭 시 오름차순/내림차순 정렬 지원.
- **필터링**: 상태 필터 (전체 / 요청 / 수락 / 거절)

#### 컬럼 정의
| 헤더명 | 정렬 | 데이터 정의 및 로직 |
| :--- | :--- | :--- |
| **오더 ID** | O | |
| **차량 번호** | O | |
| **차종** | O | |
| **존 이름** | O | |
| **파트너 명** | O | 요청을 보낸 파트너사 명칭 |
| **요청 시간** | O | `YYYY-MM-DD HH:mm` 형식 |
| **합의 유형** | O | 1단계 승인 / 2단계 승인 (섹션 4 참조) |
| **요청 유형** | O | 변경 내용을 명시적으로 표시. 예: `현장 변경(내부→내외부)`, `전환(현장→입고)`, `입고 변경(내외부→특수)` |
| **상태** | O | **[배지]**<br>- **요청**: Warn (Orange)<br>- **수락**: Ok (Green)<br>- **거절**: Danger (Red)<br>- **기타**: Default (Gray) |

### 2.2 합의 요청 상세 (Drawer)
목록의 행(Row) 클릭 시 우측 드로어가 열리며, 상세 정보를 확인하고 의사결정을 수행합니다.

- **타이틀**: `합의 요청 상세 - {요청ID}` (예: A-1001)

#### A. 요청 정보 섹션
- **기본 정보**: 오더 ID, 차량 정보(번호 및 차종), 파트너 명.
- **합의 유형**: 1단계 승인 또는 2단계 승인 (배지 형태로 표시)
  - **1단계 승인**: Ok (Green)
  - **2단계 승인**: Warn (Orange)
- **요청 유형**: 변경 내용을 `{유형}({변경 전}→{변경 후})` 형식으로 표시
  - **현장 변경**: 현장 세차 유형 변경 (예: `현장 변경(내부→내외부)`, `현장 변경(라이트→내외부)`)
  - **전환**: 파트너 유형 전환 (예: `전환(현장→입고)`)
  - **입고 변경**: 입고 세차 유형 변경 (예: `입고 변경(내외부→특수)`, `입고 변경(내외부→협의)`)
- **요청 사유**: 파트너사가 입력한 사유 텍스트.
- **세차 항목**: 추가 수행이 필요한 항목 리스트 (예: 내부세차, 특수오염제거).
- **청구 금액**:
  - **상태 = '요청'**: 수정 가능한 **숫자 입력(Input)** 필드로 노출. (운영자가 금액을 수정하여 승인 가능 - 네고)
  - **그 외 상태**: 수정 불가능(Disabled) 상태로 노출.
- **요청 코멘트**: 파트너사(수행원)가 합의 요청 시 입력한 메시지. 모든 상태에서 표시.
- **반려 코멘트**: 운영자가 반려 시 입력한 사유. **'거절' 상태에서만 표시**.

#### B. 현장 사진 섹션
- **이미지**: 세차 전 상태를 증빙하는 현장 사진 미리보기 영역. (현재 Placeholder 제공)

#### C. 승인 및 반려 처리 (Footer/Action)
상태가 **'요청'**일 경우에만 하단 액션 버튼이 노출됩니다. 그 외 상태에서는 '닫기' 버튼만 제공됩니다.

1.  **승인 (Approve)**
    - **트리거**: '승인' 버튼 클릭.
    - **로직**: 현재 입력된 '청구 금액'으로 비용을 확정하며, 상태를 **'수락'**으로 변경.
2.  **반려 (Reject)**
    - **트리거**: '반려' 버튼 클릭.
    - **UI 동작**: 드로어 내부 최하단에 **반려 사유 입력 영역(Card)**이 활성화됨 (별도 팝업 아님).
    - **반려 확정**: 사유 입력 후 '반려 확정' 버튼 클릭 시, 상태를 **'거절'**로 변경하고 입력된 사유를 **반려 코멘트**에 저장.
    - **취소**: 반려 입력 모드를 종료하고 상세 화면 유지.

## 3. 비즈니스 로직

### 3.1 상태 전이 및 수정 제한
- **수정 권한**: 오직 **'요청'** 상태에서만 청구 금액 수정 및 승인/반려 처리가 가능합니다.
- **종결 처리**: **'수락'** 또는 **'거절'** 상태로 변경된 건은 최종 상태로 간주하여, 더 이상 금액이나 상태를 변경할 수 없습니다.

### 3.2 금액 합의 (Negotiation)
- 운영자는 파트너사가 요청한 초기 금액을 확인 후, 합의된 금액으로 **Input 필드를 수정한 뒤 승인**할 수 있습니다. 시스템은 승인 시점의 금액을 최종 합의 금액으로 저장합니다.

---

## 4. 승인 프로세스 유형

합의 요청은 **승인 단계**에 따라 두 가지 프로세스로 구분됩니다.

| 구분 | 1단계 승인 | 2단계 승인 |
| :--- | :--- | :--- |
| **노출 방식** | 파트너 어드민 + 인터널 어드민 **동시 노출** | 파트너 어드민 **선노출** → 선승인 후 인터널 어드민 노출 |
| **승인 주체** | 파트너 매니저 또는 쏘카 운영자 (선착순 1인) | 파트너 매니저(1차) → 쏘카 운영자(최종) |
| **목적** | 현장 대기 시간 최소화 | 고비용 건에 대한 비용 남용 방지 |

### 4.1 1단계 승인

- **정의**: 요청 건이 접수되면 파트너 어드민과 인터널 어드민 양쪽에 **즉시 노출**되며, 어느 쪽에서든 승인하면 합의가 완료되는 프로세스
- **목적**: 현장 대기 시간을 최소화하여, 작업자의 번거로움으로 인한 **필수 작업 누락을 방지**

### 4.2 2단계 승인

- **정의**: 파트너사 관리자가 **선승인을 완료해야만** 인터널 어드민에 노출되며, 이후 쏘카 운영자가 최종 승인을 해야 합의가 완료되는 프로세스
- **목적**: 고비용이 발생하는 입고 건에 대해 파트너사 내부의 **1차 필터링**을 거쳐 비용 남용을 방지

---

## 5. 요청 유형별 워크플로우

### 5.1 A 유형: 전환(현장→입고)

현장 해결이 불가능하여 입고(특수) 세차로 전환이 필요한 경우

| 항목 | 내용 |
| :--- | :--- |
| **요청 유형 값** | `전환(현장→입고)` |
| **변경 내용** | [파트너 유형: 현장] → [파트너 유형: 입고], [세차 유형: 특수] |
| **적용 프로세스** | **1단계 승인** |

#### 워크플로우
```
1. [현장 수행원] 차량 상태 확인 후 '특수 세차(입고)' 합의 요청
       ↓
2. [시스템] 파트너 어드민 및 인터널 어드민 합의 요청 목록에 동시 노출
       ↓
3. [관리자] 파트너 매니저 또는 쏘카 운영자 중 선착순 1인 승인
       ↓
4. [시스템] 합의 완료 처리 (상태: 수락)
```

---

### 5.2 B 유형: 현장 변경({변경 전}→{변경 후})

오염도 심화 등으로 인해 현장에서 세차 단계를 상향해야 하는 경우

| 항목 | 내용 |
| :--- | :--- |
| **요청 유형 값 예시** | `현장 변경(내부→내외부)`, `현장 변경(라이트→내외부)` |
| **변경 케이스** | • 내부, 외부 → 내외부<br>• 라이트 → 내부, 외부, 내외부 |
| **적용 프로세스** | **1단계 승인** |

#### 워크플로우
```
1. [현장 수행원] 오염도 증빙 사진 첨부 후 세차 단계 상향 요청
       ↓
2. [시스템] 파트너 어드민 및 인터널 어드민 동시 노출
       ↓
3. [관리자] 파트너 매니저 또는 쏘카 운영자 승인
       ↓
4. [시스템] 합의 완료 및 변경된 세차 유형으로 오더 정보 갱신
```

> **💡 비고**: 2단계 승인이 아닌 **1단계 승인** 프로세스를 적용합니다.
> 2단계 승인 적용 시 대기 시간이 발생하여, 수행원이 필요한 세차 작업을 포기하거나 누락하는 현상을 방지하기 위함입니다.

---

### 5.3 C 유형: 입고 변경({변경 전}→{변경 후})

입고 후 검수 과정에서 발견된 특수 오염 처리가 필요한 경우

| 항목 | 내용 |
| :--- | :--- |
| **요청 유형 값 예시** | `입고 변경(내외부→특수)`, `입고 변경(내외부→협의)` |
| **변경 케이스** | 입고 세차 중 세차 유형 [내외부] → [특수, 협의] |
| **적용 프로세스** | **2단계 승인** (파트너 선승인 필수) |

> **💡 참고**: 입고 파트너는 내부/외부 단독 세차 유형이 없으므로, 상향 대상은 내외부 → 특수/협의만 해당됩니다.

#### 워크플로우
```
1. [입고 수행원] 추가 비용(부품비, 특수 약품비 등)이 포함된 합의 요청 등록
       ↓
2. [시스템] 파트너 어드민에만 우선 노출 (인터널 어드민 미노출)
       ↓
3. [파트너 매니저] 1차 검토 수행
       ├─ 반려 시 → 수행원에게 반송 (프로세스 종료)
       └─ 승인 시 → '선승인 완료' 상태로 변경 및 인터널 어드민 노출
              ↓
4. [쏘카 운영자] 인터널 어드민에서 '선승인'된 건 확인 후 최종 승인
       ↓
5. [시스템] 합의 완료 처리 (상태: 수락)
```

> **⚠️ 비고**: 스스로 비용을 책정하는 구조에서 발생할 수 있는 **도덕적 해이 및 비용 남용**을 방지하기 위해 2단계 승인 프로세스를 적용합니다.